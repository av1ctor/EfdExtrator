Extrator de EFD/Sintegra para Excel/Csv/SQLite/Access/Pdf
Copyright 2017-2020 by André Vicentini (avtvicentini)
Licenciado sob GNU GPL-2.0-ou-posterior

Quando o aplicativo é executado sem passar nenhum parâmetro, será mostrada a interface gráfica para seleção dos arquivos e marcação de opções.

Recursos:

    - Importa tanto arquivos do Sped EFD, quanto do Sintegra
	
    - Exporta para os formatos Excel (.xlsx e .xml), CSV, SQLite 3 (.db) e Access (.accdb)
    
    - Gera, diretamente para PDF, os seguintes relatórios do PVA EFD-ICMS-IPI:
        - LRE
        - LRS
        - LRAICMS
        - LRAICMS-ST
        - CIAP
        
    - Carrega os seguintes arquivos csv gerados pelos relatórios do SAFI no Infoview BO:
        - SAFI_NFe_Destinatario
        - SAFI_NFe_Emitente_Itens
        - SAFI_NFe_Emitente
        - SAFI_CTe_CNPJ
        
    - Carrega os seguintes arquivos csv gerados pelos relatórios no Launchpad BO:
        - NFE_Emitente_Itens_SP_OSF
    
    - Carrega os seguintes arquivos xlsx gerados pelos relatórios no Launchpad BO:
        - NFe_Destinatario_OSF
        - NFe_Emitente_Itens_OSF
        - NFe_Emitente_OSF
        - CTe_CNPJ_Emitente_Tomador_Remetente_Destinatario_OSF
        - SAT_-_CuponsEmitidosPorContribuinteCNPJ_OSF
        - SAT_-_ItensDeCuponsCNPJ_OSF
        
    - Utiliza os seguintes bancos de dados do SAFI:
        - Cadastro de contribuintes e regimes (CadSefaz_Regimes)
        - GIA's
        - Inidôneos

    - Extrai, formatando as planilhas geradas para facilitar a análise e a compreensão, os seguintes registros da EFD:
        0000 (MESTRE)
        0150 (PARTICIPANTE)
        0200 (ITEM_ID)
        0300 (BEM_CIAP)
        0305 (BEM_CIAP_INFO)
        0450 (INFO_COMPL)
        0460 (OBS_LANCAMENTO)
        0500 (CONTA_CONTAB)
        0600 (CENTRO_CUSTO)
        C100 (DOC_NF)
        C101 (DOC_NF_DIFAL)
        C110 (DOC_NF_INFO)
        C170 (DOC_NF_ITEM)
        C176 (DOC_NF_ITEM_RESSARC_ST)
        C190 (DOC_NF_ANALITICO)
        C195 (DOC_NF_OBS)
        C197 (DOC_NF_OBS_AJUSTE)
        C400 (EQUIP_ECF)
        C405 (ECF_REDUCAO_Z)
        C460 (DOC_ECF)
        C470 (DOC_ECF_ITEM)
        C490 (DOC_ECF_ANALITICO)
        C500 (DOC_NF_ELETRIC)
        C590 (DOC_NF_ELETRIC_ANALITICO)
        C800 (DOC_SAT)
        C850 (DOC_SAT_ANALITICO)
        D100 (DOC_CT)
        D101 (DOC_CT_DIFAL)
        D190 (DOC_CT_ANALITICO)
        D500 (DOC_NFSCT)
        D590 (DOC_NFSCT_ANALITICO)
        E100 (APURACAO_ICMS_PERIODO)
        E110 (APURACAO_ICMS_PROPRIO)
        E111 (APURACAO_ICMS_AJUSTE)
        E200 (APURACAO_ICMS_ST_PERIODO)
        E210 (APURACAO_ICMS_ST)
        G110 (CIAP_TOTAL)
        G125 (CIAP_ITEM)
        G130 (CIAP_ITEM_DOC)
        G140 (CIAP_ITEM_DOC_ITEM)
        H005 (INVENTARIO_TOTAIS)
        H010 (INVENTARIO_ITEM)
        K100 (ESTOQUE_PERIODO)
        K200 (ESTOQUE_ITEM)
        K230 (ESTOQUE_ORDEM_PROD)

    - Realiza as seguintes análises do Roteiro 3.01 do MTF:
        LRE:
         - seleciona documentos fiscais em papel
         - seleciona documentos fiscais emitidos pelo próprio contribuinte
         - documentos fiscais não escriturados
         - documentos fiscais escriturados em valores superiores
         - documentos fiscais escriturados em duplicidade
         - crédito do imposto em valor superior ao resultante da aplicação da alíquota informada pela base de cálculo
         - operações interestaduais com alíquota do imposto superior a 12%
         - operações com crédito, acima do máximo permitido, de fornecedores enquadrados no Regime Simples Nacional
         - entradas interestaduais de produtos importados, com alíquota do imposto superior a 4%
         - crédito de operações com substituição tributária
         - seleciona crédito por devolução de mercadorias
         - indicação incorreta da Inscrição Estadual do fornecedor
         - operações realizadas com fornecedores com a inscrição suspensa, inapta, baixada ou nula no cadastro de contribuintes
         - entradas com crédito do imposto nos CFOP 1556/2556 (“uso e consumo”)
         - seleciona operações escrituradas com crédito do imposto no CFOP 1949/2949 (“outras entradas”)
         - seleciona operações escrituradas nos CFOP 1601 (“recebimento de crédito de ICMS”) e 1602 (“recebimento de saldo credor de outro estabelecimento da empresa”)
         - seleciona operações de devolução de mercadorias de maior valor
         - seleciona operações com maiores valores de imposto creditado
         - seleciona operações de maior valor, independente do valor crédito do imposto
         
        LRS:
         - débito do imposto em valor inferior ao resultante da aplicação da alíquota informada pela base de cálculo
         - operações interestaduais com alíquota inferior à alíquota prevista para o Estado de destino
         - operações interestaduais com alíquota de 4%
            NOTA: selecionadas as 1000 maiores operações
         - operações interestaduais, para destinatário não contribuinte, com alíquota inferior à interna
            NOTAS: 1. não está sendo verificado o NCM, apresentando falsos positivos
                   2. em razão da EC 87/2015, pode ser usada a alíquota interestadual, com o difal contemplando o restante da alíquota
         - seleciona operações de transferências interestaduais para outros estabelecimentos da empresa
            NOTA: realizada somente a seleção por CNPJ base
         - operações com destinatários incluídos no cadastro de inidôneos
            NOTA: impossível ocorrer com a NF-e/CT-e, já que só é permitido emitir o DF-e se o destinatário estiver ativo
         - seleciona operações escrituradas nos CFOP 5949/6949 (“outras saídas”)
            NOTA: selecionadas as 1000 maiores operações
         - operações de remessa para depósito fechado ou armazém geral (CFOP 5905/6905), verificando se o destinatário está regularmente inscrito como depósito fechado ou armazém geral
            NOTAS: 1. não existe CNAE para depósito fechado, então a verificação só é feita para AG
                   2. como o cadastro de contribuintes do SAFI só inclui o CNAE principal, é necessário verificar no Cadesp se o destinatário tem nos CNAEs secundários o CNAE de AG
         - seleciona operações de consignação mercantil ou industrial (CFOP 5917/6917)
         - seleciona operações de remessa para demonstração (CFOP 5912/6912)
         - seleciona operações de remessa para industrialização por encomenda (CFOP 5901/6901)
         - seleciona operações de exportações;
         - seleciona operações de remessas para a Zona Franca de Manaus (ZFM) e Área de Livre Comércio (ALC)
         - sequência de numeração dos documentos fiscais inconsistente
         - seleciona operações com maiores valores de imposto debitado
         - seleciona operações de maior valor, independente do valor do débito do imposto
         - seleciona operações na qualidade de substituto tributário
            NOTA: selecionadas as 1000 maiores operações
        
    - Faz resumos por CFOP, CST e CST+CFOP, tanto para o LRE, quanto para o LRS

    - Todas as análises e resumos são realizados por meio de scripting (ver pasta scripts), sendo possível alterá-los, ou mesmo acrescentar novas análises, sem necessidade do código-fonte do extrator
    
Modo de usar (linha de comando):
    
    EfdExtrator.exe Opções efd-ou-sintegra.txt [relatorio-bo.csv] [relatorio-bo.xlsx]
    
    Notas:
        - No lugar do nome dos arquivos, podem ser usadas máscaras, como por exemplo: *.txt *.csv *.xlsx
        - Os arquivos .txt podem ser em formato Sintegra ou EFD
        - Os arquivos .csv do SAFI devem manter o padrão de nome dado pelo Infoview BO, mas podem ser usados prefixos e sufixos no nome, como por exemplo: \"2017 SAFI_NFe_Emitente_Itens parte 1.csv\"
        - Os arquivos .xlsx devem manter o padrão de nome dado pelo Infoview BO, mas podem ser usados prefixos e sufixos no nome, como por exemplo: \"2019 NFe_Emitente_Itens_OSF parte 1.xlsx\"
        - No final da extração será gerado um arquivo .xlsx para ser aberto no Excel 2003 ou superior (exceto se o formato de saída for null)
    
    Opções:
        -ajuda
         Mostra esta tela de ajuda
         
        -gerarRelatorios:
         Gera os relatórios do EFD-ICMS-IPI no formato PDF.
         
        -filtrarCnpjs cnpj1,cnpj2,...:
         Extrai somente os registros com os mesmos CNPJs (de emitentes ou destinatários) dos contidos na lista de CNPJs informada (separada por vírgula; zeros à esq).
         
        -filtrarChaves chave1,chave2,... ou @arquivo:
         Extrai somente os registros com as mesmas chaves das contidas na lista (utilizar @arquivo.txt para carregar as chaves de um arquivo, com uma chave por linha, sem linhas vazias ou espaços entre as chaves).
         
        -realcar:
         Cria um realce, nos relatórios em PDF, nos registros que corresponderem à -filtrarCnpjs ou -filtrarChaves.
         
        -naoGerarLre, -naoGerarLrs e -naoGerarLraicms:
         Deixam de gerar os respectivos livros quando -gerarRelatorios é utilizada.

        -naoAnalisar e -naoResumir:
         Deixam de gerar as planilhas de inconsistências e resumos, respectivamente.
         
        -formatoDeSaida xml|csv|xlsx|sqlite|access|null:
         Altera o formato de saída do padrão xlsx para csv, XML, SQLite (.db) ou Access (.accdb).
         
        -complementarDados:
         Inclui dados complementares na planilha (aba Saídas ou Entradas para docs de emissão própria) que será gerada e que não constam na EFD, caso os arquivos .csv do SAFI ou os .xlsx do Infoview BO sejam fornecidos. AVISO: não utilize as informações relacionadas ao ICMS (alíquota, BC, valor, etc), pois esses dados serão retirados dos DF-e's e não da escrituração.
         
        -somenteRessarcimentoST:
         Extrai somente documentos do LRS que contenham o registro C176 relativo ao ressarcimento ST.
         
        -dbEmDisco:
         Grava os dados intermediários em disco, poupando memória.
         
        -manterDB:
         Preserva o arquivo de dados intermediários (formato SQLite3).

    
Sobre as análises e cruzamentos:

    As análises e os cruzamentos são realizados em Lua scripting (ver scripts/analises.lua). 
    Com isso, é possível realizar novos cruzamentos apenas atualizando os scripts, sem necessidade de recompilar o aplicativo. 
    A sintaxe SQL utilizada nas queries deve ser a do SQLite. 
    O formato das tabelas criadas internamente pode ser visto em scripts/config.lua.


Dicas:
   
    Como processar EFDs de grandes contribuintes:
    1. Utilize a opção -formatoDeSaida sqlite caso o número de registros seja > 1.048.576 (limite do Excel)
       - o DB é gerado no formato do SQLite3. Para acessá-lo no Power Query ou Access, é necessário instalar o driver disponível em http://www.ch-werner.de/sqliteodbc/
    2. Utilize o Power Query para filtrar os dados do DB e importá-los no Excel, ou carregue o DB no Access e faça a seleção dos dados:
       - instalador do Power Query: https://www.microsoft.com/pt-BR/download/details.aspx?id=39379
       - ou utilizar o https://sqlitestudio.pl/ para abrir o DB e fazer a seleção dos registros diretamente
    3. Utilize as opções -filtrarCnpjs e/ou -filtrarChaves para limitar os registros que serão extraídos, quando já estiver com a relação de chaves e/ou CNPJs (passo 3)
    4. Utilize a opção -formatoDeSaida null para não gerar a planilha de extração, quando estiver gerando apenas os relatórios do EDF-ICMS-IPI
        
        
Observações:
    
    Oferecido sem qualquer garantia. 
    Estando ainda em versão beta, sem testes suficientes, nunca confie 100% nos resultados. 
    Este software pode ser copiado e distribuído livremente. 
    
Autores:    

    - André Vicentini (avtvicentini@fazenda.sp.gov.br)
    - As tabelas de cadastro de contribuinte, regimes e inidôneos foram baseadas nas tabelas do SAFI
    - As tabelas de descrição de CFOP e CST foram baseadas nas respectivas tabelas do AUD 2.0
    
Bibliotecas utilizadas:

    - IUP: http://webserver2.tecgraf.puc-rio.br/iup/
    - Lua: https://www.lua.org/
    - libxml2: http://www.xmlsoft.org/
    - PDFium: https://opensource.google/projects/pdfium
    - libiconv: https://www.gnu.org/software/libiconv/
    - SQLite3: https://www.sqlite.org/index.html
    - libxlsxwriter: https://github.com/jmcnamara/libxlsxwriter
    - XLSX I/O: https://github.com/brechtsanders/xlsxio
    - OpenSSL: https://www.openssl.org/

Ferramentas utilizadas:
    - FreeBASIC: https://www.freebasic.net/
    - Mingw-64: http://mingw-w64.org/

Código-fonte:
    https://github.com/av1ctor/EfdExtrator
